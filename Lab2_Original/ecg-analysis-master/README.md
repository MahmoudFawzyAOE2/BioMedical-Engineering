<a href="https://www.ugent.be/"><img src="https://styleguide.ugent.be/files/uploads/logo_UGent_NL_RGB_2400_kleur_witbg.png" title="UGent" alt="UGent" width="200"></a>

# ECG analysis

> This page describes the codebehind of the MATLAB scripts used in our research of:

> Steijns, F.; Tóth, M.I.; Demolder, A.; Larsen, L.E.; Desloovere, J.; Renard, M.; Raedt, R.; Segers, P.; De Backer, J.; Sips, P. Ambulatory Electrocardiographic Monitoring and Ectopic Beat Detection in Conscious Mice. Sensors 2020, 20, 3867.

## Table of Contents

- [Installation](#installation)
- [Features](#features)
- [Usage](#usage)
- [Examples](#examples)
- [License](#license)

![Recordit GIF](http://g.recordit.co/EwDQXhBFie.gif)

## Installation:
The code was written and tested in MATLAB R2019b.
Running the scripts only requires the installment of Signal Processing Toolbox.

## Features
The developed scripts are capable of analyzing murine electrocardiograms, with the feature extraction of different ECG-parameters, including average HR, mean RR-interval and HRV. The code also provides functionality for ectopic beat detection.

## Usage

### PeakDetect.m 
The main function for R-peak detection, displaying the found peaks and diagrams based on the peak distance.

- **INPUTS:**
    - inputPath - A full path to a .mat file.
    - fs - Frequency, given in Hertz. Mandatory input argument.
    - minPeakHeight - The minimum peak height to detect a peak.
           Optional argument, (default = 0.5).
    - minPeakDist - The minimum distance between 2 peaks.
           Optional argument, (default = 50).

- **OUTPUTS:**
    - figMain, figDiffLine, figDiffHist - references for the figures.
           Function AnalyzeECG() uses them.
    - diffLine - The difference line diagram, containing the outliers
    - locs - locations of the peaks
    - BPM - Beat per Minute
    - FWHM - Full-Width at Half-Maximum
    - outliers - the number of outliers found. Outlier = a peak which differs by more than 100% from the moving average of the RR    intervals.

#### Example
```
[figMain, figDiffLine, figDiffHist, ecg, diffMap, locs, BPM, fwhm, outliers] = PeakDetect("001.mat",1000);
PeakDetect("001.mat",1000,0.5,50);
PeakDetect("001.mat",1000);
```

### AnalyzeECG.m
Applies R-peak detection on multiple files, prints the plots to PDFs and information about the analysis to a text file.

Collects the .mat files from the specified folder, applies R- peak detection, then prints ectopic beats to separate pdf
files (ROIs), and the difference histogram and line diagram.
- Prints information about the analysis to a text file:
    - BPM
    - Number of R peaks
    - Mean RR interval
    - Full-Width at Half-Maximum
    - Number of outliers
    - The input arguments of the analysis

- **INPUTS:**
    - folderName - A full path to the folder containing the .mat files.
    - fs - Frequency, given in Hertz. Mandatory input argument.
    - movavgth - Ectopic beats will be classified as peaks differing more than movavgth from the moving average of the RR interval. Set it to 0.3, for a 30% threshold. Optional argument.
    - minPeakHeight - The minimum peak height to detect a peak.
           Optional argument, (default = 0.5).
    - minPeakDist - The minimum distance between 2 peaks.
           Optional argument, (default = 50).

#### Example
```
AnalyzeECG('C:\FolderWithFiles', 1000, 0.3, 0.5, 50);
AnalyzeECG('C:\FolderWithFiles', 1000);
```

### ConcatFiles.m
Concats the .mat files found in the folder specified by 'folderName'.
It should contain a full path to a folder with .mat files in it.

- **INPUTS:**
    - folderName - A full path to the folder containing the .mat files.
    
#### Example
```
ConcatFiles('C:\FolderWithFiles');
```

### FilterWithFFT.m
- **Steps:**
    - Splits the input signal into 25000 long segments.
    - Transforms the segment into frequency domain with FFT.
    - Applies band-pass filtering.
    - Transforms the segment back to time domain with IFFT.
    - Merges the 25000 long segments back into the original input size.
    
- **INPUTS:**
    - ecg - A data vector containing the ECG signal.
    
#### Example
```
FilterWithFFT(ecg);
```

### SEGScript.m 
Takes a raw unprocessed .SEG file, applies High-Pass filter then downsamples it.
The script does not take any parameters, the save and load directory can be changed manually in the code itself.
Both variables shall be set to a directory.

### PlotHist.m 
Plots a histogram based on the RR intervals, and calculates the Full-Width at Half-Maximum (FWHM) of the input signal and its polarity.
The main function for R-peak detection, displaying the found peaks and diagrams based on the peak distance.
- **INPUTS:**
    - diffLine - The difference line diagram, created by the PeakDetect.m function.
    - meanRRinterval - A scalar of mean RR interval, generated by the PeakDetect.m function.
    
- **OUTPUTS:**
    - figDiffHist - A reference for the histogram figure.
    - fwhm - FWHM in number of bins -> in ms.
    
#### Example
```
[figDiffHist, fwhm] = PlotHist(diffLine, meanRRinterval);
```


## Examples

Performing R-peak detection on an input file with 1000Hz frequency, which is placed in the following directory:
```
'C:\Users\Files\001.mat'
```
The following command can be used:
```
PeakDetect("C:\Users\Files\001.mat",1000);
```
Example command for the same file, providing minPeakHeight = 0.5, minPeakDist = 50 (default values):
```
PeakDetect("C:\Users\Files\001.mat",1000,0.5,50);
```

For a complete analysis of multiple segments, the following example commands can be used:

```
AnalyzeECG('C:\FolderWithFiles', 1000);
AnalyzeECG('C:\FolderWithFiles', 1000, 0.3, 0.5, 50);
```
In this case, the result of the analysis will be saved in the provided directory, including the eptopic beat detection.


## License
----

Copyright 2020 Ghent University

Authors: Máté István Tóth, Lars Larsen, Robrecht Raedt, Felke Steijns, Patrick Sips, Patrick Segers

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at 
   http://www.apache.org/licenses/LICENSE-2.0
 
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

When using this code please refer to: Steijns, F.; Tóth, M.I.; Demolder, A.; Larsen, L.E.; Desloovere, J.; Renard, M.; Raedt, R.; Segers, P.; De Backer, J.; Sips, P. Ambulatory Electrocardiographic Monitoring and Ectopic Beat Detection in Conscious Mice. Sensors 2020, 20, 3867.

----
